<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Nofi.vn</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;700;800&family=Merriweather:wght@900&display=swap" rel="stylesheet">

<style>
/* ===== TOKENS (base) ===== */
:root{
  --fg:#eae9e5; --muted:#a8b0ba; --panel:rgba(255,255,255,.06); --border:rgba(255,255,255,.14);
  --accent:#7dd3fc; --accent2:#a78bfa; --shadow:0 26px 80px rgba(0,0,0,.5);
  --bg1:#1a2440; --bg2:#0b0f14; --bg3:#07090c;
  --tileMin: 240px;
  --link:#8ddcff; --placeholder:rgba(234,233,229,.55);
}

/* ===== THEMES ===== */
:root[data-theme="glass"]{
  --fg:#eae9e5; --muted:#a8b0ba; --panel:rgba(255,255,255,.06); --border:rgba(255,255,255,.14);
  --accent:#7dd3fc; --accent2:#a78bfa; --shadow:0 26px 80px rgba(0,0,0,.5);
  --bg1:#1a2440; --bg2:#0b0f14; --bg3:#07090c;
  --link:#8ddcff; --placeholder:rgba(234,233,229,.55);
}
:root[data-theme="sepia"]{
  --fg:#2a2016; --muted:#6a5741;
  --panel:rgba(255,255,255,.92); --border:#e2d5bf;
  --accent:#d97706; --accent2:#a16207; --shadow:0 18px 50px rgba(0,0,0,.16);
  --bg1:#f7efdf; --bg2:#f1e6d2; --bg3:#eadcc4;
  --link:#b45309; --placeholder:rgba(42,32,22,.45);
}
:root[data-theme="neon"]{
  --fg:#eceaff; --muted:#bfbaff; --panel:rgba(93,0,255,.22); --border:rgba(197,171,255,.35);
  --accent:#22d3ee; --accent2:#a855f7; --shadow:0 26px 80px rgba(0,0,0,.55);
  --bg1:#12022b; --bg2:#0b0122; --bg3:#07001a;
  --link:#67e8f9; --placeholder:rgba(236,234,255,.55);
}

/* ===== BASE ===== */
*{box-sizing:border-box}
html,body{height:100%}
html,body{
  margin:0; padding:0; width:100%; min-height:100%;
  background:radial-gradient(1200px 1200px at 10% -10%, var(--bg1) 0%, var(--bg2) 40%, var(--bg3) 100%);
  background-size:cover; background-attachment:fixed; background-repeat:no-repeat;
  color:var(--fg); font:15.5px/1.65 "Inter", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility;
}

/* blobs (ẩn ở sepia) */
.blob{position:fixed; inset:auto auto -22% -12%; width:60vmax; height:60vmax;
  background:radial-gradient(circle at 30% 30%, rgba(125,211,252,.25), transparent 60%);
  filter:blur(40px); pointer-events:none; animation:float 18s ease-in-out infinite alternate; z-index:0}
.blob.b2{inset:-18% -12% auto auto; width:55vmax; height:55vmax;
  background:radial-gradient(circle at 70% 40%, rgba(167,139,250,.22), transparent 60%); animation-duration:22s}
@keyframes float{to{transform:translate(2%, -3%) scale(1.05)}}
:root[data-theme="sepia"] .blob,
:root[data-theme="sepia"] .blob.b2{ display:none }

/* header */
.mast{max-width:1200px;margin:16px auto 8px;padding:10px 18px; display:flex; align-items:center; justify-content:space-between; z-index:2; position:relative}
.brand{display:flex;align-items:center;gap:10px}
.logo{width:34px;height:34px;border-radius:50%;
  background: radial-gradient(120% 120% at 30% 20%, rgba(125,211,252,.22), rgba(167,139,250,.18) 60%, rgba(255,255,255,.06) 80%),
              conic-gradient(from 210deg, rgba(125,211,252,.35), rgba(167,139,250,.35), rgba(125,211,252,.35));
  border:1px solid rgba(255,255,255,.25);
  box-shadow:0 14px 36px rgba(0,0,0,.5), inset 0 8px 18px rgba(255,255,255,.08);
}
:root[data-theme="sepia"] .logo{
  background: linear-gradient(180deg,#f4e6cf,#ead9bb);
  border:1px solid #e6d8c1; box-shadow:0 8px 18px rgba(0,0,0,.08) inset, 0 10px 24px rgba(0,0,0,.08);
}
.title{margin:0;font:900 20px "Merriweather", serif}
.now{font:700 12px/1 "Inter"; color:var(--muted)}

/* toolbar */
.toolbar{max-width:1200px;margin:0 auto 10px;padding:0 18px; display:flex; gap:10px; align-items:center; flex-wrap:wrap}
.input, .theme{
  display:flex; gap:8px; align-items:center;
  border:1px solid var(--border); background:var(--panel); padding:8px 10px; border-radius:12px; backdrop-filter: blur(8px);
}
.input{ flex:1; min-width:260px }
.input input{
  width:100%; border:0; outline:0; background:transparent; color:var(--fg); font:600 14px "Inter";
}
.input input::placeholder{ color:var(--placeholder) }
.theme select{
  border:0; outline:0; background:transparent; color:var(--fg); font:700 13px "Inter";
}

/* grid */
.gridWrap{max-width:1200px;margin:0 auto 60px;padding:0 18px; position:relative; z-index:1}
.grid{ display:grid; grid-template-columns:repeat(auto-fill, minmax(var(--tileMin), 1fr)); gap:14px }

/* tile */
.tile{
  position:relative; padding:16px 14px; min-height:120px; display:flex; align-items:flex-start; gap:12px;
  background:var(--panel); border:1px solid var(--border); border-radius:16px; box-shadow:var(--shadow);
  backdrop-filter: blur(8px); cursor:pointer; user-select:none;
  transition:transform .2s ease, box-shadow .25s ease, background .25s ease;
}
.tile:hover{ transform:translateY(-2px); box-shadow:0 26px 80px rgba(0,0,0,.55); background:rgba(255,255,255,.08) }
:root[data-theme="sepia"] .tile{ background:var(--panel); border-color:#decfb8 }
:root[data-theme="sepia"] .tile:hover{ background:#ffffff; border-color:#d7c6aa; box-shadow:0 16px 40px rgba(0,0,0,.12) }

.dot{ width:10px; height:10px; border-radius:50%; background:radial-gradient(circle at 30% 30%, var(--accent), var(--accent2));
  box-shadow:0 0 0 2px rgba(255,255,255,.12) inset; margin-top:4px; flex:0 0 auto; }
.tTitle{font:800 16px/1.45 "Inter"; color:var(--fg)}
.tMeta{font:700 11px/1 "Inter"; color:var(--muted); margin-top:8px}

/* overlay + reader */
.overlay{
  position:fixed; inset:0; background:rgba(0,0,0,.5);
  opacity:0; visibility:hidden; transition:opacity .35s ease, visibility .35s ease; z-index:3;
}
.overlay.open{ opacity:1; visibility:visible }
.reader{
  position:fixed; left:50%; top:50%;
  transform: translate(-50%,-50%) scale(.2);
  transform-origin: var(--ox,50%) var(--oy,50%);
  width:min(1080px, 94vw); max-height:84vh;
  background:rgba(18,22,27,.92); border:1px solid var(--border);
  box-shadow:0 40px 120px rgba(0,0,0,.6); backdrop-filter: blur(14px);
  border-radius:18px; z-index:4; opacity:0; pointer-events:none;
  transition: transform .45s cubic-bezier(.2,.8,.2,1), opacity .35s ease;
}
.reader.open{ opacity:1; transform: translate(-50%,-50%) scale(1); pointer-events:auto; }
.reader .shell{max-width:100%; padding:16px 18px 20px}
.reader .head{display:flex;align-items:center;justify-content:space-between;gap:10px}
.reader h2{margin:0;font:800 clamp(18px,2.2vmin,26px) "Inter"}
.reader .meta{font:700 12px "Inter"; color:var(--muted)}
.reader .close{border:1px solid var(--border); background:var(--panel); color:var(--fg);
  padding:7px 12px; border-radius:10px; cursor:pointer; font:700 12px "Inter"}
.reader .body{margin-top:10px; font-size:16.5px; max-height:64vh; overflow:auto}

/* ===== Sepia Paper: panel & nội dung đọc rõ ràng ===== */
:root[data-theme="sepia"] .reader{
  background:#fffdf7; border-color:#e6d8c1; box-shadow:0 30px 90px rgba(0,0,0,.12);
  color:#2a2016;
}
:root[data-theme="sepia"] .reader h1,
:root[data-theme="sepia"] .reader h2,
:root[data-theme="sepia"] .reader h3,
:root[data-theme="sepia"] .reader h4{ color:#1a1209 !important }
:root[data-theme="sepia"] .reader .meta{ color:#6a5741 }
:root[data-theme="sepia"] .reader .close{ background:#fff; border-color:#e6d8c1; color:#2a2016 }

/* Ép lại màu chữ & xoá nền tối trong nội dung copy từ theme dark */
:root[data-theme="sepia"] .reader .body,
:root[data-theme="sepia"] .reader .body *:not(a):not(code):not(pre){
  color:#2a2016 !important;
  background:transparent !important;
  border-color:#e6d8c1 !important;
}
:root[data-theme="sepia"] .reader .body a{ color:#b45309 !important }
:root[data-theme="sepia"] .reader .body strong,
:root[data-theme="sepia"] .reader .body b{ color:#1a1209 !important }
:root[data-theme="sepia"] .reader .body em,
:root[data-theme="sepia"] .reader .body i{ color:#3b2d1f !important }
:root[data-theme="sepia"] .reader .body code,
:root[data-theme="sepia"] .reader .body pre{
  color:#1f160e !important; background:#fff7ea !important;
  border:1px solid #eadfcf !important; border-radius:6px; padding:.2em .35em;
}
:root[data-theme="sepia"] .reader .body hr{
  border:0; border-top:1px solid #e6d8c1 !important;
}

/* responsive */
@media (max-width:680px){ :root{ --tileMin: 180px; } }
</style>
</head>
<body>
<div class="blob"></div><div class="blob b2"></div>

<header class="mast">
  <div class="brand">
    <h1 class="title">NOFI.VN</h1>
  </div>
  <div id="now" class="now"></div>
</header>

<div class="toolbar">
  <div class="input"><input id="q" type="search" placeholder="Tìm tiêu đề… (gõ để lọc)"></div>
  <div class="theme">
    <label for="theme" style="font:700 12px 'Inter';opacity:.75;margin-right:4px">Giao diện:</label>
    <select id="theme">
      <option value="glass">Glass Dark</option>
      <option value="sepia">Sepia Paper</option>
      <option value="neon">Neon Purple</option>
    </select>
  </div>
</div>

<main class="gridWrap">
  <div id="loading" class="center">Đang tải bài…</div>
  <section id="grid" class="grid" aria-live="polite"></section>
</main>

<!-- Overlay + Reader -->
<div id="overlay" class="overlay"></div>
<aside id="reader" class="reader" aria-hidden="true">
  <div class="shell">
    <div class="head">
      <div>
        <h2 id="rTitle"></h2>
        <div id="rMeta" class="meta"></div>
      </div>
      <button id="rClose" class="close">Đóng</button>
    </div>
    <div id="rBody" class="body"></div>
  </div>
</aside>

<script>
/* ==== CONFIG ==== */
const BLOG_BASE = "https://blognofivn.blogspot.com"; // đổi blog ở đây
const WANT_MAX  = 80;
document.getElementById('now').textContent = new Date().toLocaleString('vi-VN');

/* ==== THEME SWITCHER (persist) ==== */
const root = document.documentElement;
const themeSelect = document.getElementById('theme');
(function initTheme(){
  const stored = localStorage.getItem('nofi_theme') || 'glass';
  root.setAttribute('data-theme', stored);
  themeSelect.value = stored;
})();
themeSelect.addEventListener('change', ()=>{
  root.setAttribute('data-theme', themeSelect.value);
  localStorage.setItem('nofi_theme', themeSelect.value);
});

/* ==== Utils ==== */
const $ = (s,el=document)=>el.querySelector(s);
const fmt = s => s ? new Date(s).toLocaleString('vi-VN') : '';

/* ==== JSONP ==== */
function jsonp(url){
  return new Promise((resolve,reject)=>{
    const cb = "cb_" + Math.random().toString(36).slice(2);
    const sc = document.createElement('script');
    sc.src = url + (url.includes('?')?'&':'?') + 'callback=' + cb;
    let done=false;
    window[cb] = (data)=>{ done=true; resolve(data); cleanup(); };
    sc.onerror = ()=>{ if(!done){ reject(new Error('JSONP load error')); cleanup(); } };
    function cleanup(){ delete window[cb]; sc.remove(); }
    document.body.appendChild(sc);
  });
}
async function fetchAllJSONP(base=BLOG_BASE, wanted=WANT_MAX){
  let url = base.replace(/\/?$/,'') + '/feeds/posts/default?alt=json-in-script&max-results=100';
  const out = [];
  for(let i=0;i<10 && out.length<wanted && url;i++){
    const d = await jsonp(url);
    const entries = (d.feed && d.feed.entry) || [];
    out.push(...entries);
    const next = (d.feed && d.feed.link || []).find(l=>l.rel==='next');
    if(next && next.href){
      url = next.href.replace('alt=json','alt=json-in-script');
      if(!/alt=json-in-script/.test(url)) url += (url.includes('?')?'&':'?') + 'alt=json-in-script';
    } else url = null;
  }
  return out.slice(0,wanted);
}

/* ==== Sanitize + Normalize (safe regex) ==== */
const SCRIPT_RE = new RegExp('<script[\\s\\S]*?<' + '\\/script>', 'gi');
const STYLE_RE  = new RegExp('<style[\\s\\S]*?<'  + '\\/style>' , 'gi');
function sanitizeHTML(html=''){
  return (html || '').replace(SCRIPT_RE,'').replace(STYLE_RE,'');
}
function normalize(e){
  const title=(e.title&&e.title.$t)||'(Không tiêu đề)';
  const html =(e.content&&e.content.$t)||(e.summary&&e.summary.$t)||'';
  return { title, published:e.published?e.published.$t:'', html:sanitizeHTML(html) };
}

/* ==== Build grid of tiles ==== */
let POSTS = [];
function renderGrid(list){
  const grid = $('#grid'); grid.innerHTML='';
  list.forEach(p=>{
    const tile = document.createElement('article');
    tile.className = 'tile';
    tile.innerHTML = `
      <div class="dot" aria-hidden="true"></div>
      <div style="min-width:0">
        <div class="tTitle">${p.title}</div>
        <div class="tMeta">${fmt(p.published)}</div>
      </div>
    `;
    tile.addEventListener('click', ()=> openReaderFromTile(tile, p));
    grid.appendChild(tile);
  });
}

/* ==== Search filter ==== */
document.getElementById('q').addEventListener('input', e=>{
  const kw = e.target.value.trim().toLowerCase();
  const filtered = kw ? POSTS.filter(p=>p.title.toLowerCase().includes(kw)) : POSTS;
  renderGrid(filtered);
});

/* ==== Reader morph (tile -> panel) ==== */
function openReaderFromTile(tile, p){
  const reader  = $('#reader');
  const overlay = $('#overlay');
  $('#rTitle').textContent = p.title;
  $('#rMeta').textContent  = fmt(p.published);
  $('#rBody').innerHTML    = p.html;

  const r = tile.getBoundingClientRect();
  const ox = (r.left + r.width/2) / innerWidth * 100;
  const oy = (r.top  + r.height/2) / innerHeight * 100;
  reader.style.setProperty('--ox', ox+'%');
  reader.style.setProperty('--oy', oy+'%');

  overlay.classList.add('open');
  reader.classList.add('open');
  reader.setAttribute('aria-hidden','false');

  const close = ()=>{
    overlay.classList.remove('open');
    reader.classList.remove('open');
    reader.setAttribute('aria-hidden','true');
    overlay.removeEventListener('click', close);
    document.getElementById('rClose').removeEventListener('click', close);
  };
  overlay.addEventListener('click', close, {once:true});
  document.getElementById('rClose').addEventListener('click', close, {once:true});
}

/* ==== Boot ==== */
(async ()=>{
  try{
    const raw = await fetchAllJSONP(BLOG_BASE, WANT_MAX);
    POSTS = raw.map(normalize).sort((a,b)=>new Date(b.published)-new Date(a.published));
    document.getElementById('loading')?.remove();
    renderGrid(POSTS);
  }catch(err){
    document.getElementById('loading').textContent = 'Lỗi tải (JSONP): ' + err.message;
  }
})();
</script>
</body>
</html>
