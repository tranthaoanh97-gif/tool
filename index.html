<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Nofi.vn</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;700;800&family=Merriweather:wght@900&display=swap" rel="stylesheet">

<style>
html,body{
  margin:0;padding:0;width:100%;min-height:100%;
  background:radial-gradient(1200px 1200px at 10% -10%,#1a2440 0%,#0b0f14 40%,#07090c 100%);
  color:#eae9e5;
  font:15.5px/1.65 "Inter",system-ui,sans-serif;
  -webkit-text-size-adjust:none; /* fix nổ chữ mobile */
  text-size-adjust:none;
}

/* blobs */
.blob{position:fixed;inset:auto auto -22% -12%;width:60vmax;height:60vmax;
  background:radial-gradient(circle at 30% 30%,rgba(125,211,252,.25),transparent 60%);
  filter:blur(40px);pointer-events:none;animation:float 18s ease-in-out infinite alternate;z-index:0}
.blob.b2{inset:-18% -12% auto auto;width:55vmax;height:55vmax;
  background:radial-gradient(circle at 70% 40%,rgba(167,139,250,.22),transparent 60%);animation-duration:22s}
@keyframes float{to{transform:translate(2%,-3%) scale(1.05)}}

/* header */
.mast{max-width:1200px;margin:16px auto 8px;padding:10px 18px;display:flex;align-items:center;justify-content:space-between}
.title{margin:0;font:900 24px "Merriweather",serif}
.now{font:700 12px/1 "Inter";color:#a8b0ba}

/* toolbar */
.toolbar{max-width:1200px;margin:0 auto 10px;padding:0 18px;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.input,.theme{display:flex;gap:8px;align-items:center;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.06);padding:8px 10px;border-radius:12px}
.input{flex:1;min-width:260px}
.input input{width:100%;border:0;outline:0;background:transparent;color:#eae9e5;font:600 14px "Inter"}
.input input::placeholder{color:rgba(234,233,229,.55)}
.theme select{border:0;outline:0;background:transparent;color:#eae9e5;font:700 13px "Inter"}

/* grid */
.gridWrap{max-width:1200px;margin:0 auto 60px;padding:0 18px}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:14px}
.tile{padding:16px 14px;min-height:120px;display:flex;align-items:flex-start;gap:12px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.14);border-radius:16px;cursor:pointer;transition:all .25s}
.tile:hover{transform:translateY(-2px);background:rgba(255,255,255,.1)}
.dot{width:10px;height:10px;border-radius:50%;background:radial-gradient(circle at 30% 30%,#7dd3fc,#a78bfa);margin-top:4px}
.tTitle{font:800 16px/1.45 "Inter";color:#eae9e5}
.tMeta{font:700 11px/1 "Inter";color:#a8b0ba;margin-top:8px}

/* overlay */
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);opacity:0;visibility:hidden;z-index:3;transition:opacity .3s}
.overlay.open{opacity:1;visibility:visible}

/* reader modal — absolute để UC không đơ */
.reader{
  position:absolute;left:50%;top:140px;
  transform:translateX(-50%);
  width:min(1080px,94vw);max-height:75vh;
  background:rgba(18,22,27,.92);color:#eae9e5;
  border:1px solid rgba(255,255,255,.14);
  border-radius:18px;z-index:4;opacity:0;pointer-events:none;
  display:flex;flex-direction:column;
  box-shadow:0 40px 120px rgba(0,0,0,.6);
  transition:opacity .28s ease, transform .28s ease;
}
.reader.open{opacity:1;pointer-events:auto}
.reader h2{margin:0;font:800 20px "Inter";padding:14px 16px 4px}
.reader .meta{font:700 12px "Inter";color:#a8b0ba;padding:0 16px 10px}
.reader .body{
  padding:0 16px 16px;
  font-size:16px;line-height:1.8;
  text-align:justify; /* căn đều hai bên */
  overflow-y:auto;scrollbar-width:none;
}
.reader .body::-webkit-scrollbar{display:none}

/* chữ ký NẰM TRONG nội dung, mặc định ẩn */
.reader .signature{
  text-align:center;margin:20px 0 6px;color:#a8b0ba;
  font:700 13px "Inter";opacity:0;transition:opacity .25s ease;user-select:none;
}

/* footer */
.foot{position:fixed;left:0;right:0;bottom:0;display:flex;align-items:center;justify-content:center;padding:10px 18px;font:700 12px "Inter";color:#a8b0ba}
</style>
</head>
<body>
<div class="blob"></div><div class="blob b2"></div>

<header class="mast">
  <h1 class="title">NOFI.VN</h1>
  <div id="now" class="now"></div>
</header>

<div class="toolbar">
  <div class="input">
    <input id="q"
           type="text" inputmode="search"
           autocomplete="off" autocorrect="off"
           autocapitalize="none" spellcheck="false"
           placeholder="Tìm tiêu đề… (gõ để lọc)">
  </div>
  <div class="theme">
    <label for="theme" style="font:700 12px 'Inter';opacity:.75;margin-right:4px">Giao diện:</label>
    <select id="theme">
      <option value="glass">Glass Dark</option>
      <option value="sepia">Sepia Paper</option>
      <option value="neon">Neon Purple</option>
    </select>
  </div>
</div>

<main class="gridWrap">
  <div id="loading">Đang tải bài…</div>
  <section id="grid" class="grid" aria-live="polite"></section>
</main>

<div id="overlay" class="overlay"></div>

<aside id="reader" class="reader" aria-hidden="true">
  <h2 id="rTitle"></h2>
  <div id="rMeta" class="meta"></div>
  <div id="rBody" class="body"></div>
  <!-- KHÔNG đặt signature cố định ở đây nữa -->
</aside>

<footer class="foot">Tôi như trẻ nhỏ ngồi bên hiên nhà chờ nghe thế kỷ tàn phai</footer>

<script>
const BLOG_BASE="https://blognofivn.blogspot.com";
const WANT_MAX=80;
document.getElementById('now').textContent=new Date().toLocaleString('vi-VN');

/* ===== Utils ===== */
const $=(s,el=document)=>el.querySelector(s);
const fmt=s=>s?new Date(s).toLocaleString('vi-VN'):'';
const norm=(s='')=>s.toLowerCase()
  .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
  .replace(/đ/g,'d').replace(/Đ/g,'d');

/* ===== JSONP ===== */
function jsonp(url){
  return new Promise((resolve,reject)=>{
    const cb="cb_"+Math.random().toString(36).slice(2);
    const sc=document.createElement('script');
    sc.src=url+(url.includes('?')?'&':'?')+'callback='+cb;
    let done=false;
    window[cb]=(data)=>{done=true;resolve(data);cleanup();};
    sc.onerror = ()=>{ if(!done){ reject(new Error('JSONP load error')); cleanup(); } };
    function cleanup(){ delete window[cb]; sc.remove(); }
    document.body.appendChild(sc);
  });
}
async function fetchAllJSONP(base=BLOG_BASE,wanted=WANT_MAX){
  let url=base.replace(/\/?$/,'')+'/feeds/posts/default?alt=json-in-script&max-results=100';
  const out=[];
  for(let i=0;i<10 && out.length<wanted && url;i++){
    const d=await jsonp(url);
    const entries=(d.feed && d.feed.entry) || [];
    out.push(...entries);
    const next=(d.feed && d.feed.link || []).find(l=>l.rel==='next');
    if(next && next.href){
      url = next.href.replace('alt=json','alt=json-in-script');
      if(!/alt=json-in-script/.test(url)) url += (url.includes('?')?'&':'?') + 'alt=json-in-script';
    }else url=null;
  }
  return out.slice(0,wanted);
}

/* ===== Sanitize + normalize ===== */
const SCRIPT_RE=/<script[\s\S]*?<\/script>/gi;
const STYLE_RE =/<style[\s\S]*?<\/style>/gi;
function sanitizeHTML(html=''){ return (html||'').replace(SCRIPT_RE,'').replace(STYLE_RE,''); }
function normalize(e){
  const title=(e.title&&e.title.$t)||'(Không tiêu đề)';
  const html =(e.content&&e.content.$t)||(e.summary&&e.summary.$t)||'';
  return { title, published:e.published?e.published.$t:'', html:sanitizeHTML(html) };
}

/* ===== Build grid ===== */
let POSTS=[];
function renderGrid(list){
  const grid=$('#grid'); grid.innerHTML='';
  list.forEach(p=>{
    const tile=document.createElement('article');
    tile.className='tile';
    tile.innerHTML=`
      <div class="dot"></div>
      <div style="min-width:0">
        <div class="tTitle">${p.title}</div>
        <div class="tMeta">${fmt(p.published)}</div>
      </div>`;
    tile.addEventListener('click',()=>openReaderFromTile(tile,p));
    grid.appendChild(tile);
  });
}

/* ===== Search filter (robust Chrome mobile + IME) ===== */
const qEl=document.getElementById('q');
let composing=false, rafId=0;
function runFilter(){
  cancelAnimationFrame(rafId);
  rafId=requestAnimationFrame(()=>{
    const kw=norm(qEl.value.trim());
    const filtered = kw ? POSTS.filter(p=>norm(p.title).includes(kw)) : POSTS;
    renderGrid(filtered);
  });
}
qEl.addEventListener('compositionstart',()=>{composing=true;});
qEl.addEventListener('compositionend',()=>{composing=false;runFilter();});
qEl.addEventListener('input',()=>{if(!composing) runFilter();},{passive:true});
qEl.addEventListener('keyup',()=>{if(!composing) runFilter();},{passive:true});
qEl.addEventListener('search',runFilter,{passive:true});

/* ===== Modal open ===== */
function openReaderFromTile(tile,p){
  const reader=$('#reader'), overlay=$('#overlay');
  const body = $('#rBody');

  // set content
  $('#rTitle').textContent=p.title;
  $('#rMeta').textContent=fmt(p.published);
  body.innerHTML=p.html;

  // thêm chữ ký vào CUỐI nội dung (scroll theo bài)
  const sig=document.createElement('div');
  sig.className='signature';
  sig.textContent='─── ❖ ───';
  body.appendChild(sig);

  // vị trí modal dưới toolbar
  const tb=document.querySelector('.toolbar').getBoundingClientRect();
  reader.style.top = Math.round(tb.bottom + 45) + 'px';

  // mở layer
  overlay.classList.add('open');
  reader.classList.add('open');
  reader.setAttribute('aria-hidden','false');

  // show/hide chữ ký theo vị trí cuộn
  function onScroll(){
    const nearBottom = body.scrollTop + body.clientHeight >= body.scrollHeight - 5;
    sig.style.opacity = nearBottom ? 1 : 0;
  }
  body.addEventListener('scroll', onScroll);
  onScroll(); // set trạng thái ban đầu

  // đóng
  const close=()=>{
    overlay.classList.remove('open');
    reader.classList.remove('open');
    reader.setAttribute('aria-hidden','true');
    overlay.removeEventListener('click',close);
    body.removeEventListener('scroll', onScroll);
  };
  overlay.addEventListener('click', close, {once:true});
}

/* ===== Boot ===== */
(async()=>{
  try{
    const raw=await fetchAllJSONP(BLOG_BASE,WANT_MAX);
    POSTS=raw.map(normalize).sort((a,b)=>new Date(b.published)-new Date(a.published));
    document.getElementById('loading')?.remove();
    renderGrid(POSTS);
  }catch(err){
    document.getElementById('loading').textContent='Lỗi tải (JSONP): '+err.message;
  }
})();
</script>
</body>
</html>
