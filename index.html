<!DOCTYPE html>
<html data-theme="light" lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Qu·∫£n l√Ω th√¥ng tin c√¥ng ty</title>
<style>
  /* Base layout ch? d√πng bi?n m√†u (kh√¥ng c?t m√†u c?ng) */
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--text)}
  header{position:sticky;top:0;background:var(--card);backdrop-filter:blur(6px);padding:12px 16px;border-bottom:1px solid var(--border);z-index:10}
  h1{margin:0;font-size:20px}
  .pill{font-size:12px;background:var(--card);border:1px solid var(--border);padding:6px 10px;border-radius:999px;color:var(--muted)}
  .wrap{max-width:1200px;margin:0 auto;padding:16px;display:grid;grid-template-columns:380px 1fr;gap:16px}
  @media (max-width:1000px){.wrap{grid-template-columns:1fr}}
  .card{background:var(--card);border:1px solid var(--border);border-radius:14px}
  .card .inner{padding:16px}
  label{display:block;font-size:12px;color:var(--muted);margin:8px 0 6px}
  input,textarea,select{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:var(--input);color:var(--text);outline:none}
  input:focus,textarea:focus,select:focus{border-color:var(--accent)}
  .row2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .btn{display:inline-flex;gap:8px;align-items:center;padding:10px 14px;border-radius:10px;border:1px solid var(--border);background:var(--card);color:var(--text);cursor:pointer}
  .btn.primary{background:var(--accent);border-color:var(--accent);color:#fff;font-weight:700}
  .btn.danger{background:var(--danger);border-color:var(--danger);color:#fff}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap}
  .list{display:grid;gap:8px}
  /* List items (d√® n?n theo theme) */
  .item{border:1px solid var(--border);border-radius:10px;background:var(--card)}
  .item summary{cursor:pointer;list-style:none;padding:12px 16px;display:flex;gap:10px;align-items:center;color:var(--text)}
  .item summary::-webkit-details-marker{display:none}
  .meta{display:grid;grid-template-columns:160px 1fr;gap:8px;padding:8px 16px 16px 16px;color:var(--text)}
  .muted{color:var(--muted)} .right{margin-left:auto}
  .badge{padding:2px 8px;border:1px solid var(--border);border-radius:999px;font-size:11px;color:var(--text);background:var(--card)}
  .pagination{display:flex;gap:8px;align-items:center;justify-content:flex-end;margin-top:8px}
  #err{position:fixed;left:16px;right:16px;bottom:16px;background:#2a0f1a;border:1px solid #b8284c;color:#ffd9e1;padding:10px 12px;border-radius:10px;display:none;white-space:pre-wrap;z-index:9999}
  .authbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:8px}
  .authbar input{max-width:200px}
  .hint{font-size:12px;color:var(--muted)}
  .lock{background:var(--card);border:1px solid var(--border);padding:8px 10px;border-radius:10px;color:var(--text)}
  .disabled{opacity:.6;pointer-events:none}
  body.logged-out .wrap{grid-template-columns:1fr !important;}
  /* Field manager modal theo theme */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:9998}
  .modal .panel{background:var(--card);border:1px solid var(--border);border-radius:14px;max-width:720px;width:96%;padding:16px;color:var(--text)}
  .table{width:100%;border-collapse:collapse}
  .table th,.table td{border-bottom:1px solid var(--border);padding:8px;text-align:left;font-size:14px;color:var(--text)}
</style>


<style id="cm-theme-css">
  :root{
    /* Light (default) */
    --bg:#f5f7ff; --card:#ffffff; --text:#0e1330; --muted:#5a5f7a;
    --border:#dfe3f5; --input:#ffffff; --accent:#2a7de1; --danger:#b61c3f;
  }
  [data-theme="dark"]{
    --bg:#0b1020; --card:#111733; --text:#e6e9f5; --muted:#a7afd9;
    --border:#1f2750; --input:#0b1230; --accent:#4cc9f0; --danger:#b61c3f;
  }
  body{ background:var(--bg); color:var(--text); }
  .card{ background:var(--card) !important; border:1px solid var(--border) !important; border-radius:14px; }
  .card .inner{ padding:16px; }
  input, textarea, select{
    background:var(--input) !important; color:var(--text) !important;
    border:1px solid var(--border) !important; border-radius:10px; padding:10px 12px;
    outline:none;
  }
  input:focus, textarea:focus, select:focus{ border-color:var(--accent) !important; }
  .btn{ background:var(--card) !important; color:var(--text) !important; border:1px solid var(--border) !important; border-radius:10px; padding:10px 14px; }
  .btn.primary{ background:var(--accent) !important; border-color:var(--accent) !important; color:#fff !important; font-weight:600; }
  .btn.danger{ background:var(--danger) !important; border-color:var(--danger) !important; color:#fff !important; }
  .badge, .pill{ background:var(--card) !important; border:1px solid var(--border) !important; color:var(--muted) !important; border-radius:999px; padding:2px 8px; font-size:11px; }
  /* Floating theme switcher */
  #cm-theme-switch{ position:fixed; bottom:12px; left:12px; z-index:9999; display:flex; align-items:center; gap:6px; background:var(--card); border:1px solid var(--border); padding:6px 8px; border-radius:10px; box-shadow:0 2px 10px rgba(0,0,0,.08); }
  #cm-theme-switch label{ color:var(--muted); font-size:12px; }
</style>


<style id="cm-theme-contrast-fix">
  /* Stronger contrast for status + list items */
  #authStatus, .lock { background: var(--card) !important; color: var(--text) !important; border: 1px solid var(--border) !important; border-radius: 10px; padding: 6px 10px; display:inline-block; }
  details.item summary, details.item .meta, .list .item, .list .item * { color: var(--text) !important; }
  /* Search box text visibility */
  #q { color: var(--text) !important; }
  /* Badges that show counts look muted too much; bump to text color */
  #count, .badge.strong { color: var(--text) !important; }
</style>

<style id="cm-theme-override">
  /* √ê?m b?o item/list/modals d√πng n?n + vi?n theo theme */
  details.item, .list .item { background: var(--card) !important; border:1px solid var(--border) !important; }
  details.item summary { background: transparent !important; color: var(--text) !important; }
  .modal .panel, .table th, .table td, .badge, .pill { background: var(--card) !important; color: var(--text) !important; border-color: var(--border) !important; }
</style>

</head>
<body>
<header>
  <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap">
    <h1>Qu·∫£n l√Ω th√¥ng tin c√¥ng ty</h1>
    <span class="pill">D·ªØ li·ªáu l∆∞u t·∫°i tr√¨nh duy·ªát ‚Ä¢ T√¨m ki·∫øm ‚Ä¢ L·ªçc ‚Ä¢ Ph√¢n trang</span>
    <span class="pill">Nh·∫≠p/Xu·∫•t d·ªØ li·ªáu ‚Ä¢ M·∫≠t kh·∫©u ‚Ä¢ T√πy ch·ªânh nh·∫≠p li·ªáu</span>
    <span id="dbInfo" class="pill" style="margin-left:auto">DB: √¢‚Ç¨‚Äù</span>
  </div>
  <div class="authbar">
    <div class="lock"><span id="authStatus">Tr·∫°ng th√°i: Ch∆∞a ƒëƒÉng nh·∫≠p</span></div>
    <input id="pw" type="password" placeholder="Nh·∫≠p m·∫≠t kh·∫©u" />
    <button class="btn" id="btnLogin">ƒêƒÉng nh·∫≠p</button>
    <button class="btn" id="btnLogout">ƒêƒÉng xu·∫•t</button>
    <button class="btn" id="btnSetPw">T·∫°o / Thay ƒë·ªïi m·∫≠t kh·∫©u</button>
    <button class="btn" id="btnFields">T·∫°o th√™m tr∆∞·ªùng nh·∫≠p li·ªáu</button>
    <span class="hint" id="pwHint"></span>
  </div>
</header>

<div id="err"></div>

<main class="wrap">
  <section class="card" id="formCard">
    <div class="inner">
      <h2 style="margin:0 0 10px 0">‚ûï Th√™m / S·ª≠a</h2>
      <form id="f"><input type="hidden" id="id" /><div id="dynFields"></div>
        <div class="toolbar" style="margin-top:12px">
          <button class="btn primary" type="submit">L∆∞u</button>
          <button class="btn" type="button" id="clear">Nh·∫≠p l·∫°i t·ª´ ƒë·∫ßu</button>
        </div>
      </form>
      <hr style="border:0;border-top:1px solid #1c2347;margin:16px 0" />
      <div class="toolbar">
        <button class="btn" id="exportJson">‚¨áÔ∏è Xu·∫•t d·ªØ li·ªáu</button>
        <button class="btn" id="importJson">‚¨ÜÔ∏è Nh·∫≠p d·ªØ li·ªáu</button>
        <button class="btn" id="exportPortable">üì¶ ƒê√≥ng g√≥i d·ªØ li·ªáu</button>
        <button class="btn danger" id="wipe">üß® X√≥a to√†n b·ªô d·ªØ li·ªáu</button>
      </div>
      <p class="muted" style="margin-top:8px">Ph·∫ßn ch·ª©c nƒÉng d√†nh cho ng∆∞·ªùi qu·∫£n l√Ω</p>
    </div>
  </section>

  <section class="card">
    <div class="inner">
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <h2 style="margin-right:auto">Danh s√°ch c√¥ng ty</h2>
        <span class="badge">S·∫Øp x·∫øp: 
          <select id="sortBy"><option value="name">T√™n(A‚ÜíZ)</option><option value="created_desc" selected>M·ªõi nh·∫•t</option><option value="created_asc">C≈© nh·∫•t</option></select>
        </span>
        <span class="badge">Hi·ªÉn th·ªã m·ªói trang: 
          <select id="pageSize"><option>25</option><option selected>50</option><option>100</option><option>200</option></select>
        </span>
        <span id="count" class="badge">0 d·ªØ li·ªáu</span>
      </div>
      <div style="display:flex;gap:8px;align-items:center;margin:8px 0">
        <input id="q" placeholder="Nh·∫≠p th√¥ng tin t√¨m ki·∫øm" />
        <button class="btn" id="clearQ">X</button>
      </div>
      <div id="list" class="list"></div>
      <div id="empty" class="muted" style="padding:16px">Kh√¥ng c√≥ d·ªØ li·ªáu.</div>
      <div class="pagination">
        <button class="btn" id="prev">‚Üê Trang tr∆∞·ªõc</button>
        <span class="muted" id="pageInfo">Trang 1/1</span>
        <button class="btn" id="next">Trang sau ‚Üí</button>
      </div>
    </div>
  </section>
</main>

<!-- Field manager modal -->
<div class="modal" id="fieldsModal">
  <div class="panel">
    <h3 style="margin:0 0 10px 0">Danh s√°ch c√°c tr∆∞·ªùng ƒë√£ c√≥ v√† nh·∫≠p th√™m</h3>
    <p class="muted" style="margin:0 0 12px 0">T√≠ch v√†o c·ªôt b·∫Øt bu·ªôc ƒë√≥ s·∫Ω l√† tr∆∞·ªùng b·∫Øt bu·ªôc, kh√¥ng th·ªÉ ƒë·ªÉ tr·ªëng.</p>
    <table class="table" id="fieldsTable"></table>
    <div class="row2" style="margin-top:12px">
      <div><input id="newLabel" placeholder="Nh·∫≠p t√™n tr∆∞·ªùng mu·ªën t·∫°o th√™m, v√≠ d·ª•: ƒê·ªãa ch·ªâ" /></div>
      <div><button class="btn" id="addField">Th√™m tr∆∞·ªùng</button></div>
    </div>
    <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end">
      <button class="btn" id="closeFields">ƒê√≥ng</button>
      <button class="btn primary" id="saveFields">L∆∞u l·∫°i</button>
    </div>
  </div>
</div>

<script>
// ASCII-only JS ‚Äî Password + Custom Fields
(function(){
  'use strict';

  // ===== Error box =====
  var errBox=null; window.addEventListener('error',function(e){ if(!errBox)errBox=document.getElementById('err'); errBox.textContent='JS Error: '+e.message; errBox.style.display='block'; });
  window.addEventListener('unhandledrejection',function(e){ if(!errBox)errBox=document.getElementById('err'); errBox.textContent='Promise Rejection: '+(e.reason&&e.reason.message?e.reason.message:e.reason); errBox.style.display='block'; });

  // ===== Keys =====
  var KEY_HASH='CM_PW_HASH_V1';
  var KEY_AUTH='CM_AUTH_OK_V1';
  var KEY_SCHEMA='CM_SCHEMA_V1'; // [{key,label,required}...]

  // ===== Utils =====
  function textToHex(buf){ var a=new Uint8Array(buf); var s=''; for(var i=0;i<a.length;i++){ var b=a[i].toString(16); if(b.length<2)b='0'+b; s+=b; } return s; }
  function sha256(s){ return crypto.subtle.digest('SHA-256', new TextEncoder().encode(s)).then(textToHex); }
  function isAuthed(){ return sessionStorage.getItem(KEY_AUTH)==='1'; }
  function setAuthed(v){ if(v) sessionStorage.setItem(KEY_AUTH,'1'); else sessionStorage.removeItem(KEY_AUTH); renderAuth(); }
  function getHash(){ try{ return localStorage.getItem(KEY_HASH)||''; }catch(e){ return ''; } }
  function setHash(h){ try{ localStorage.setItem(KEY_HASH,h); }catch(e){} }
  function slug(s){ return String(s||'').toLowerCase().replace(/[^a-z0-9]+/g,'_').replace(/^_+|_+$/g,''); }
  function esc(s){ return String(s||'').replace(/[&<>"']/g,function(m){ return ({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]); }); }

  // ===== Schema (localStorage) =====
  function loadSchema(){
    try{ var raw=localStorage.getItem(KEY_SCHEMA); if(raw) return JSON.parse(raw); }catch(e){}
    var def=[
      {key:'name',label:'Name',required:true},
      {key:'phone',label:'Phone',required:false},
      {key:'email',label:'Email',required:false},
      {key:'address',label:'Address',required:false},
      {key:'notes',label:'Notes',required:false,type:'textarea'}
    ];
    localStorage.setItem(KEY_SCHEMA, JSON.stringify(def));
    return def;
  }
  function saveSchema(arr){ try{ localStorage.setItem(KEY_SCHEMA, JSON.stringify(arr)); }catch(e){} }

  // ===== DB =====
  var DB_NAME='QLTTCT', STORE='companies'; var db;
  function openDB(){ return new Promise(function(resolve,reject){ var req=indexedDB.open(DB_NAME,1); req.onupgradeneeded=function(e){ var db0=e.target.result; var store=db0.createObjectStore(STORE,{keyPath:'id',autoIncrement:true}); store.createIndex('createdAt','createdAt',{unique:false}); }; req.onsuccess=function(){resolve(req.result)}; req.onerror=function(){reject(req.error)}; }); }
  function tx(mode){ return db.transaction(STORE,mode).objectStore(STORE); }
  function buildSearchKey(c){
    var sch = loadSchema(); var out=[]; for(var i=0;i<sch.length;i++){ var k=sch[i].key; if (c[k]) out.push(String(c[k])); }
    return out.join(' ').toLowerCase();
  }
  function addCompany(c){ c.createdAt=Date.now(); c.search=buildSearchKey(c); return new Promise(function(res,rej){ var r=tx('readwrite').add(c); r.onsuccess=function(){res(r.result)}; r.onerror=function(){rej(r.error)}; }); }
  function updateCompany(id,c){ c.id=id; c.search=buildSearchKey(c); return new Promise(function(res,rej){ var r=tx('readwrite').put(c); r.onsuccess=function(){res()}; r.onerror=function(){rej(r.error)}; }); }
  function deleteCompany(id){ return new Promise(function(res,rej){ var r=tx('readwrite').delete(id); r.onsuccess=function(){res()}; r.onerror=function(){rej(r.error)}; }); }
  function getAll(){ return new Promise(function(res,rej){ var r=tx('readonly').getAll(); r.onsuccess=function(){res(r.result||[])}; r.onerror=function(){rej(r.error)}; }); }

  // ===== UI refs & state =====
  function el(id){ return document.getElementById(id); }
  var listEl=el('list'), emptyEl=el('empty'), countEl=el('count'), dbInfo=el('dbInfo'), pageInfo=el('pageInfo'), formCard=el('formCard'), dynFields=el('dynFields');
  var state={ q:'', sortBy:'created_desc', pageSize:50, page:1, total:0, rows:[] };
  var schema = loadSchema();

  // Render dynamic form based on schema
  function renderFormFields(){
    dynFields.innerHTML='';
    schema.forEach(function(f){
      var wrap=document.createElement('div');
      if (f.type==='textarea'){
        wrap.innerHTML='<label>'+esc(f.label)+(f.required?' *':'')+'</label><textarea id="fld_'+f.key+'" rows="3"></textarea>';
      } else {
        wrap.innerHTML='<label>'+esc(f.label)+(f.required?' *':'')+'</label><input id="fld_'+f.key+'" />';
      }
      dynFields.appendChild(wrap);
    });
  }

  // ===== Auth UI =====
  function setWriteEnabled(enabled){
    if (formCard) formCard.style.display = enabled ? '' : 'none';
  }
  function renderAuth(){
    var hash = getHash();
    var authed = isAuthed();
    var status = authed ? 'ƒêƒÉng nh·∫≠p' : 'ƒêƒÉng xu·∫•t';
    if (!hash) status += ' ‚Ä¢ Ch∆∞a c√†i m·∫≠t kh·∫©u';
    el('authStatus').textContent='Tr·∫°ng th√°i: '+status;
    el('pwHint').textContent = hash ? '' : 'Note: C√†i m·∫≠t kh·∫©u tr∆∞·ªõc khi thao t√°c n·ªôi dung n√†y.';
    document.body.classList.toggle('logged-out', !authed);
    setWriteEnabled(authed);
    renderRows();
  }

  // ===== List render =====
  function renderRows(){
    var rows=state.rows, q=state.q.toLowerCase(), sortBy=state.sortBy, pageSize=state.pageSize, page=state.page;
    // rebuild search if missing
    rows.forEach(function(r){ if (!r.search){ r.search = buildSearchKey(r); } });
    var filtered = q ? rows.filter(function(r){ return (r.search||'').indexOf(q)>=0; }) : rows.slice();
    if (sortBy==='created_desc'){ filtered.sort(function(a,b){ return (b.createdAt||0)-(a.createdAt||0); }); }
    else if (sortBy==='created_asc'){ filtered.sort(function(a,b){ return (a.createdAt||0)-(b.createdAt||0); }); }
    else if (sortBy==='name'){ filtered.sort(function(a,b){ return String(a.name||'').localeCompare(String(b.name||''),'en',{sensitivity:'base'}); }); }
    state.total = filtered.length;
    var totalPages = Math.max(1, Math.ceil(filtered.length/pageSize));
    var p = Math.min(page, totalPages); state.page=p;
    var start=(p-1)*pageSize; var pageRows = filtered.slice(start,start+pageSize);
    countEl.textContent = (state.q && state.q.trim()? (state.total + ' / ' + rows.length + ' d·ªØ li·ªáu') : (state.total + ' d·ªØ li·ªáu'));
    pageInfo.textContent = 'Trang ' + p + '/' + totalPages;
    listEl.innerHTML='';
    if (pageRows.length===0){ emptyEl.style.display='block'; return; } else { emptyEl.style.display='none'; }
    var canWrite = isAuthed();

    pageRows.forEach(function(r){
      var d=document.createElement('details'); d.className='item';
      var s=document.createElement('summary');
      var title = esc(r.name||'(No name)');
      s.innerHTML = '<strong>'+title+'</strong><span class="right muted">#'+r.id+'</span>';
      var meta=document.createElement('div'); meta.className='meta';
      // print all fields
      var html='';
      schema.forEach(function(f){ html += '<div>'+esc(f.label)+'</div><div>'+esc(r[f.key]||'-')+'</div>'; });
      html += '<div>T·∫°o h·ªìi:</div><div>'+ new Date(r.createdAt||Date.now()).toLocaleString() +'</div>';
      html += '<div></div><div style="display:flex;gap:8px;flex-wrap:wrap">';
      if (canWrite){
        html += '<button class="btn" data-act="edit" data-id="'+r.id+'">S·ª≠a</button>';
        html += '<button class="btn danger" data-act="del" data-id="'+r.id+'">X√≥a</button>';
      }
      html += '</div>';
      meta.innerHTML = html;
      d.appendChild(s); d.appendChild(meta); listEl.appendChild(d);
    });

    listEl.querySelectorAll('button[data-act="edit"]').forEach(function(btn){
      btn.addEventListener('click', function(e){
        if (!isAuthed()){ alert('Please login to edit.'); return; }
        var id=Number(e.currentTarget.getAttribute('data-id'));
        var c=state.rows.find(function(x){return x.id===id}); if(!c) return;
        el('id').value=c.id;
        schema.forEach(function(f){ var x=el('fld_'+f.key); if(x) x.value=c[f.key]||''; });
        window.scrollTo({top:0,behavior:'smooth'});
      });
    });
    listEl.querySelectorAll('button[data-act="del"]').forEach(function(btn){
      btn.addEventListener('click', function(e){
        if (!isAuthed()){ alert('Please login to delete.'); return; }
        var id=Number(e.currentTarget.getAttribute('data-id'));
        if (confirm('Delete item #'+id+' ?')){ deleteCompany(id).then(reload); }
      });
    });
  }

  function reload(){ return getAll().then(function(rows){ state.rows = rows; dbInfo.textContent='T·ªïng d·ªØ li·ªáu: '+DB_NAME+' ('+rows.length+' d·ªØ li·ªáu)'; renderRows(); }); }

  // ===== Export / Import =====
function exportPortable(){
  getAll().then(function(items){
    var pack = { items: items, schema: schema };

    // CSS: h·ªó tr·ª£ 2 theme, m·∫∑c ƒë·ªãnh Light
    var css = `
html[data-theme="light"]{
  --bg:#f5f7ff; --card:#ffffff; --text:#0e1330; --muted:#5a5f7a; --border:#dfe3f5; --input:#ffffff; --accent:#2a7de1;
}
html[data-theme="dark"]{
  --bg:#0b1020; --card:#111733; --text:#e6e9f5; --muted:#a7afd9; --border:#1f2750; --input:#0b1230; --accent:#4cc9f0;
}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,Segoe UI,Arial,sans-serif;background:var(--bg);color:var(--text)}
header{position:sticky;top:0;background:var(--card);border-bottom:1px solid var(--border);padding:12px 16px;z-index:10}
.wrap{max-width:1000px;margin:0 auto;padding:16px}
.card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px}
input,select{padding:8px 10px;border-radius:8px;border:1px solid var(--border);background:var(--input);color:var(--text);outline:none}
input:focus,select:focus{border-color:var(--accent)}
.item{border:1px solid var(--border);border-radius:10px;margin:8px 0;padding:10px 12px;background:var(--card);color:var(--text)}
.badge{padding:2px 8px;border:1px solid var(--border);border-radius:999px;font-size:11px;color:var(--text);background:var(--card)}
#switch{position:fixed;left:12px;bottom:12px;background:var(--card);border:1px solid var(--border);padding:6px 8px;border-radius:10px}
`;

    // JS viewer (th√™m c√¥ng t·∫Øc theme, m·∫∑c ƒë·ªãnh Light)
    var js = `(function(){
      'use strict';
      var DATA = JSON.parse(document.getElementById('data').textContent||'{}');
      var S = DATA.schema||[], rows = (DATA.items||[]).slice();
      rows.forEach(function(r){ r._s = buildKey(r); });
      var st = { q:'', sort:'created_desc', size:50, page:1 };

      var KEY='PORTABLE_THEME_V1';
      function applyTheme(t){ document.documentElement.setAttribute('data-theme', t==='dark'?'dark':'light'); document.getElementById('theme').value=t; }
      var saved = localStorage.getItem(KEY)||'light'; applyTheme(saved);
      document.getElementById('theme').addEventListener('change', function(){ var t=this.value==='dark'?'dark':'light'; localStorage.setItem(KEY,t); applyTheme(t); });

      function esc(s){return String(s||'').replace(/[&<>\\\"']/g,function(m){return({'&':'&amp;','<':'&lt;','>':'&gt;','\\\"':'&quot;','\\'':'&#39;'})[m];});}
      function buildKey(c){var out=[];for(var i=0;i<S.length;i++){var k=S[i].key;if(c[k]) out.push(String(c[k]));}return out.join(' ').toLowerCase();}
      function render(){
        var q = document.getElementById('q').value.toLowerCase();
        var sort = document.getElementById('sort').value;
        var size = Number(document.getElementById('size').value)||50;
        var page = st.page;

        var filtered = rows.filter(function(r){ return !q || (r._s||'').indexOf(q)>=0; });
        if (sort==='created_desc') filtered.sort(function(a,b){ return (b.createdAt||0)-(a.createdAt||0); });
        else if (sort==='created_asc') filtered.sort(function(a,b){ return (a.createdAt||0)-(b.createdAt||0); });
        else filtered.sort(function(a,b){ return String(a.name||'').localeCompare(String(b.name||''),'en',{sensitivity:'base'}); });

        var totalPages = Math.max(1, Math.ceil(filtered.length/size));
        if (page>totalPages) page = totalPages; st.page = page;
        var start=(page-1)*size; var pageRows = filtered.slice(start, start+size);

        var list = document.getElementById('list'); list.innerHTML='';
        document.getElementById('count').textContent = filtered.length+' d·ªØ li·ªáu';

        if (pageRows.length===0){ list.innerHTML='<div class="badge">No data</div>'; document.getElementById('page').textContent='Trang 1/1'; return; }
        for (var i=0;i<pageRows.length;i++){
          var r=pageRows[i];
          var html='<div class="item"><div><strong>'+esc(r.name||'(No name)')+'</strong> <span class="badge">#'+r.id+'</span></div>';
          for (var j=0;j<S.length;j++){ var f=S[j]; html+='<div>'+esc(f.label)+': '+esc(r[f.key]||'-')+'</div>'; }
          html+='<div>Ng√†y t·∫°o: '+new Date(r.createdAt||Date.now()).toLocaleString()+'</div></div>';
          list.insertAdjacentHTML('beforeend', html);
        }
        document.getElementById('page').textContent='Trang '+page+'/'+totalPages;
      }

      document.getElementById('q').addEventListener('input', function(){ st.page=1; render(); });
      document.getElementById('sort').addEventListener('change', function(){ st.page=1; render(); });
      document.getElementById('size').addEventListener('change', function(){ st.page=1; render(); });
      document.getElementById('prev').addEventListener('click', function(){ st.page=Math.max(1, st.page-1); render(); });
      document.getElementById('next').addEventListener('click', function(){ st.page=st.page+1; render(); });

      render();
    })();`;

    // HTML portable (default Light)
    var dataJson = JSON.stringify(pack).replace(/</g,'\\u003c');
    var html = '<!DOCTYPE html><html data-theme="light"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Qu·∫£n l√Ω th√¥ng tin c√¥ng ty</title><style>'+css+'</style></head><body>'+
      '<header><div class="wrap"><h2>üìí Qu·∫£n l√Ω th√¥ng tin c√¥ng ty - D·ªØ li·ªáu d√πng chung</h2></div></header>'+
      '<main class="wrap"><div class="card">'+
        '<div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">'+
          '<input id="q" placeholder="Nh·∫≠p th√¥ng tin mu·ªën t√¨m">'+
          '<span class="badge">S·∫Øp x·∫øp <select id="sort"><option value="name">T√™n (A‚ÜíZ)</option><option value="created_desc" selected>M·ªõi nh·∫•t</option><option value="created_asc">C≈© nh·∫•t</option></select></span>'+
          '<span class="badge">Hi·ªÉn th·ªã <select id="size"><option>25</option><option selected>50</option><option>100</option></select></span>'+
          '<span id="count" class="badge">0 d·ªØ li·ªáu</span>'+
          '<span id="page" class="badge">Trang 1/1</span>'+
        '</div>'+
        '<div id="list" style="margin-top:10px"></div>'+
      '</div></main>'+
      '<div id="switch"><label style="margin-right:6px;color:var(--muted)">Giao di·ªán</label><select id="theme"><option value="light" selected>S√°ng</option><option value="dark">T·ªëi</option></select></div>'+
      '<script id="data" type="application/json">'+dataJson+'</'+'script><script>'+js+'</'+'script></body></html>';

    downloadFile('Quan_ly_thong_tin_cong_ty.html', html, 'text/html');
  });
}


function downloadFile(name, content, type){ var blob=new Blob([content],{type:type||'application/octet-stream'}); var url=URL.createObjectURL(blob); var a=document.createElement('a'); a.href=url; a.download=name; a.click(); setTimeout(function(){ URL.revokeObjectURL(url); },3000); }
  function exportJSON(){ getAll().then(function(items){ var pack={v:1, exportedAt:new Date().toISOString(), schema:schema, items:items}; downloadFile('Thong-tin-cong-ty.json', JSON.stringify(pack,null,2), 'application/json'); }); }
  function importJSON(){ if(!isAuthed()){ alert('Please login to import.'); return; } var inp=document.createElement('input'); inp.type='file'; inp.accept='.json,application/json'; inp.onchange=function(){ var f=inp.files[0]; if(!f) return; f.text().then(function(txt){ try{ var obj=JSON.parse(txt); if(obj.schema){ schema=obj.schema; saveSchema(schema); renderFormFields(); } var items=obj.items||obj||[]; var store=tx('readwrite'); var i=0; (function loop(){ if(i>=items.length){ reload(); alert('ƒê√£ nh·∫≠p '+items.length+' d·ªØ li·ªáu'); return; } var it=items[i++]; delete it.id; it.search=buildSearchKey(it); var r=store.add(it); r.onsuccess=loop; r.onerror=function(e){ console.error(e); loop(); }; })(); }catch(err){ alert('Sai ƒë·ªãnh d·∫°ng: '+err.message); } }); }; inp.click(); }

  // ===== Events =====
  function bindEvents(){
    document.getElementById('f').addEventListener('submit', function(e){
      e.preventDefault(); if(!isAuthed()){ alert('Please login to save.'); return; }
      var idStr = el('id').value || '0'; var id = Number(idStr);
      var c={}; schema.forEach(function(f){ var x=el('fld_'+f.key); var v=(x&&x.value||'').trim(); if(f.required && !v && f.key==='name'){ alert('Name is required'); throw new Error('required'); } c[f.key]=v; });
      if (c.name==='') return;
      (id ? updateCompany(id,c) : addCompany(c)).then(function(){ document.getElementById('f').reset(); el('id').value=''; el('q').value=''; state.q=''; state.sortBy='created_desc'; try{ document.getElementById('sortBy').value='created_desc'; }catch(e){} reload(); });
    });
    document.getElementById('clear').addEventListener('click', function(){ document.getElementById('f').reset(); el('id').value=''; });

    document.getElementById('exportJson').addEventListener('click', exportJSON);
    document.getElementById('exportPortable').addEventListener('click', function(){ if(!isAuthed()){ alert('Please login to export portable.'); return; } exportPortable(); });
    document.getElementById('importJson').addEventListener('click', importJSON);
    document.getElementById('wipe').addEventListener('click', function(){ if(!isAuthed()){ alert('Please login to wipe DB.'); return; } if(!confirm('Thao t√°c n√†y s·∫Ω x√≥a to√†n b·ªô d·ªØ li·ªáu')) return; db.close(); indexedDB.deleteDatabase(DB_NAME); openDB().then(function(newdb){ db=newdb; reload(); }); });

    document.getElementById('q').addEventListener('input', function(){ state.q=this.value; state.page=1; renderRows(); });
    document.getElementById('clearQ').addEventListener('click', function(){ el('q').value=''; state.q=''; state.page=1; renderRows(); });
    document.getElementById('sortBy').addEventListener('change', function(){ state.sortBy=this.value; renderRows(); });
    document.getElementById('pageSize').addEventListener('change', function(){ state.pageSize=Number(this.value); state.page=1; renderRows(); });

    // Auth
    document.getElementById('btnLogin').addEventListener('click', function(){ var pw=(el('pw').value||'').trim(); if(!pw){ alert('Thao t√°c n√†y ch·ªâ s·ª≠ d·ª•ng khi ƒë√£ ƒëƒÉng nh·∫≠p'); return; } var hash=getHash(); if(!hash){ alert('Ch∆∞a c√≥ m·∫≠t kh·∫©u. S·ª≠ d·ª•ng "T·∫°o / Thay ƒë·ªïi m·∫≠t kh·∫©u" ƒë·ªÉ thi·∫øt l·∫≠p tr∆∞·ªõc'); return; } sha256(pw).then(function(h){ if(h===hash){ setAuthed(true); el('pw').value=''; } else { alert('Sai m·∫≠t kh·∫©u'); } }); });
    document.getElementById('btnLogout').addEventListener('click', function(){ setAuthed(false); });
    document.getElementById('btnSetPw').addEventListener('click', function(){ var current=prompt('M·∫≠t kh·∫©u c≈© (ƒë·ªÉ tr·ªëng n·∫øu l√† l·∫ßn ƒë·∫ßu):',''); var hash=getHash(); if(hash && !current){ alert('L√†m ∆°n nh·∫≠p m·∫≠t kh·∫©u'); return; } if(hash && current){ return sha256(current).then(function(hc){ if(hc!==hash){ alert('Nh·∫≠p ƒë√∫ng m·∫≠t kh·∫©u'); } else { askNew(); } }); } if(!hash){ askNew(); } function askNew(){ var p1=prompt('M·∫≠t kh·∫©u m·ªõi:',''); if(!p1) return; var p2=prompt('Nh·∫≠p l·∫°i:',''); if(p1!==p2){ alert('Kh√¥ng ƒë√∫ng'); return; } sha256(p1).then(function(h){ setHash(h); alert('ƒê√£ t·∫°o m·∫≠t kh·∫©u'); }); }});

    // Fields modal
    function refreshFieldsTable(){
      var tbl=document.getElementById('fieldsTable'); var rows='<tr><th>T·ª´ kh√≥a (ƒë∆∞·ª£c t·∫°o t·ª± ƒë·ªông)</th><th>T√™n tr∆∞·ªùng</th><th>B·∫Øt bu·ªôc</th><th></th></tr>';
      schema.forEach(function(f){
        rows+='<tr><td>'+esc(f.key)+'</td><td><input data-k="'+esc(f.key)+'" class="fldLabel" value="'+esc(f.label)+'" /></td><td><input type="checkbox" class="fldReq" data-k="'+esc(f.key)+'" '+(f.required?'checked':'')+' '+(f.key==='name'?'disabled':'')+' /></td><td>'+(f.key==='name'?'':'<button class="btn danger" data-del="'+esc(f.key)+'">X√≥a</button>')+'</td></tr>';
      });
      tbl.innerHTML=rows;
      tbl.querySelectorAll('button[data-del]').forEach(function(b){ b.onclick=function(){ var k=b.getAttribute('data-del'); schema=schema.filter(function(x){return x.key!==k}); refreshFieldsTable(); }; });
    }
    document.getElementById('btnFields').addEventListener('click', function(){ if(!isAuthed()){ alert('ƒêƒÉng nh·∫≠p m·ªõi s·ª≠ d·ª•ng ƒë∆∞·ª£c.'); return; } refreshFieldsTable(); document.getElementById('fieldsModal').style.display='flex'; });
    document.getElementById('closeFields').addEventListener('click', function(){ document.getElementById('fieldsModal').style.display='none'; });
    document.getElementById('addField').addEventListener('click', function(){ var label=(el('newLabel').value||'').trim(); if(!label){ alert('Enter label'); return; } var k=slug(label); if(!k){ alert('Invalid label'); return; } if(schema.some(function(x){return x.key===k})){ alert('Field exists'); return; } schema.push({key:k,label:label,required:false}); el('newLabel').value=''; refreshFieldsTable(); });
    document.getElementById('saveFields').addEventListener('click', function(){ 
      // collect edited labels/required
      var labels=document.querySelectorAll('.fldLabel'); labels.forEach(function(inp){ var k=inp.getAttribute('data-k'); var f=schema.find(function(x){return x.key===k}); if(f) f.label=inp.value; });
      var reqs=document.querySelectorAll('.fldReq'); reqs.forEach(function(chk){ var k=chk.getAttribute('data-k'); var f=schema.find(function(x){return x.key===k}); if(f && f.key!=='name') f.required=chk.checked; });
      saveSchema(schema); renderFormFields(); document.getElementById('fieldsModal').style.display='none';
    });
  }

  // ===== Init =====
  function init(){ renderFormFields(); openDB().then(function(db0){ db=db0; bindEvents(); renderAuth(); reload(); }).catch(function(e){ if(!errBox)errBox=document.getElementById('err'); errBox.textContent='Init error: '+e.message; errBox.style.display='block'; }); }
  init();
})();
</script>

<div id="cm-theme-switch">
  <label for="cm-theme-select">Giao di·ªán</label>
  <select id="cm-theme-select">
    <option value="light" selected>S√°ng</option>
    <option value="dark">T·ªëi</option>
  </select>
</div>


<script id="cm-theme-js">
(function(){
  var KEY='CM_THEME_V1';
  function apply(t){
    document.documentElement.setAttribute('data-theme', t==='dark'?'dark':'light');
    var sel=document.getElementById('cm-theme-select'); if(sel) sel.value=t;
  }
  var saved=localStorage.getItem(KEY)||'light'; apply(saved);
  document.addEventListener('DOMContentLoaded', function(){
    var sel=document.getElementById('cm-theme-select'); if(!sel) return;
    sel.value=saved;
    sel.addEventListener('change', function(){
      var t=this.value==='dark'?'dark':'light';
      localStorage.setItem(KEY,t); apply(t);
    });
  });
})();
</script>

</body>
</html>
