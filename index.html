<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Nofi.vn</title>

<!-- Font đẹp, hỗ trợ tiếng Việt -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;700;800&family=Merriweather:wght@900&display=swap" rel="stylesheet">

<style>
:root{
  --bg:#f6f1ea; --fg:#171717; --muted:#6b7280; --border:#e6ded0; --panel:#ffffff; --accent:#0ea5e9;
  --shadow:0 10px 26px rgba(0,0,0,.06);
}
@media (prefers-color-scheme: dark){
  :root{ --bg:#111315; --panel:#171a1d; --fg:#e7e3db; --muted:#a7a29a; --border:#2a2e33; --accent:#5eead4; --shadow:0 12px 30px rgba(0,0,0,.4) }
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; background:var(--bg); color:var(--fg);
  -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility;
  font:15.5px/1.6 "Inter", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
}

/* Header – gọn, chỉ 1 kẻ */
.mast{max-width:980px;margin:28px auto 12px;padding:0 18px;border-bottom:1px solid var(--border)}
.brand{display:flex;align-items:flex-end;justify-content:space-between;gap:16px;flex-wrap:wrap}
.brand h1{margin:0;font:900 38px/1 "Merriweather", serif;letter-spacing:.02em}
.brand .date{font:500 13px/1.2 "Inter";color:var(--muted)}
.rule{display:none} /* Ẩn kẻ đôi cũ */

/* List */
.wrap{max-width:980px;margin:0 auto 48px;padding:0 18px}
.list{display:grid;gap:10px}
.item{
  background:var(--panel); border:1px solid var(--border); border-radius:14px; box-shadow:var(--shadow);
  padding:14px 16px; display:flex; align-items:center; justify-content:space-between; gap:12px;
}
.title{
  font-weight:800; cursor:pointer; text-decoration:underline; text-decoration-color:rgba(14,165,233,.35); text-underline-offset:3px;
}
.time{font:600 12px/1.2 "Inter"; color:var(--muted); white-space:nowrap}

/* Khu nội dung mở rộng (accordion) */
.entry{background:var(--panel); border:1px solid var(--border); border-radius:12px; box-shadow:var(--shadow); padding:0 16px 12px}
.entry .entry-head{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:12px 0}
.entry .entry-title{font-weight:800; cursor:pointer; text-decoration:underline; text-decoration-color:rgba(14,165,233,.35); text-underline-offset:3px}
.entry .entry-time{font:600 12px/1.2 "Inter"; color:var(--muted); white-space:nowrap}
.entry .entry-body{display:none; border-top:1px dashed var(--border); padding-top:12px}
.entry.open .entry-body{display:block}
.entry .content{font-size:16.5px}

/* Loading */
.center{display:flex;justify-content:center;margin:20px 0;color:var(--muted);font-weight:600}
</style>
</head>
<body>
<header class="mast">
  <div class="brand">
    <h1>Nofi.vn</h1>
    <div class="date" id="now"></div>
  </div>
  <div class="rule" aria-hidden="true"></div>
</header>

<div class="wrap">
  <main id="list" class="list" aria-live="polite"></main>
  <div id="loading" class="center">Đang tải bài…</div>
</div>

<script>
/* ==== CONFIG ==== */
const BLOG_BASE = "https://blognofivn.blogspot.com"; // đổi blog ở đây
const WANT_MAX  = 50;                                 // số bài tối đa
const TYPE_CPM  = 520;                                  // 90 ký tự/phút
const TYPE_DELAY = Math.max(40, Math.round(60000 / TYPE_CPM)); // ms/char (≈ 666ms)
document.getElementById('now').textContent = new Date().toLocaleString('vi-VN');

/* ==== Utils ==== */
const $ = s => document.querySelector(s);
const fmt = s => s ? new Date(s).toLocaleString('vi-VN') : '';

/* ==== JSONP helper (không CORS) ==== */
function jsonp(url){
  return new Promise((resolve,reject)=>{
    const cb = "cb_" + Math.random().toString(36).slice(2);
    const sc = document.createElement('script');
    sc.src = url + (url.includes('?')?'&':'?') + 'callback=' + cb;
    let done=false;
    window[cb] = (data)=>{ done=true; resolve(data); cleanup(); };
    sc.onerror = ()=>{ if(!done){ reject(new Error('JSONP load error')); cleanup(); } };
    function cleanup(){ delete window[cb]; sc.remove(); }
    document.body.appendChild(sc);
  });
}
async function fetchAllJSONP(base=BLOG_BASE, wanted=WANT_MAX){
  let url = base.replace(/\/?$/,'') + '/feeds/posts/default?alt=json-in-script&max-results=100';
  const out = [];
  for(let i=0;i<10 && out.length<wanted && url;i++){
    const d = await jsonp(url);
    const entries = (d.feed && d.feed.entry) || [];
    out.push(...entries);
    const next = (d.feed && d.feed.link || []).find(l=>l.rel==='next');
    if(next && next.href){
      url = next.href.replace('alt=json','alt=json-in-script');
      if(!/alt=json-in-script/.test(url)) url += (url.includes('?')?'&':'?') + 'alt=json-in-script';
    } else url = null;
  }
  return out.slice(0,wanted);
}

/* ==== Chuẩn hoá: GIỮ nguyên HTML của Blogger ==== */
function sanitizeHTML(html=''){
  return html
    .replace(/<script[\s\S]*?<\/script>/gi,'')
    .replace(/<style[\s\S]*?<\/style>/gi,'');
}
function normalize(e){
  const title=(e.title&&e.title.$t)||'(Không tiêu đề)';
  const html =(e.content&&e.content.$t)||(e.summary&&e.summary.$t)||'';
  return {
    title,
    published:e.published?e.published.$t:'',
    html:sanitizeHTML(html)
  };
}

/* ==== Typewriter theo GRAPHEME (không vỡ dấu) – chỉ dùng cho TIÊU ĐỀ ==== */
function splitGraphemes(str){
  if (window.Intl && Intl.Segmenter){
    const seg = new Intl.Segmenter('vi',{granularity:'grapheme'});
    return Array.from(seg.segment(str), s=>s.segment);
  }
  return Array.from(str); // fallback
}
function typewriterText(el, text, delay=TYPE_DELAY){
  return new Promise(resolve=>{
    const units = splitGraphemes(text || '');
    let i=0; el.textContent='';
    (function tick(){
      if(i<=units.length){
        el.textContent = units.slice(0,i).join('');
        i++; setTimeout(tick, delay);
      } else resolve();
    })();
  });
}

/* ==== Accordion: chỉ mở 1 bài, không gõ nội dung ==== */
let openedEntry = null;

function renderAccordionItem(p){
  const wrap = document.createElement('article');
  wrap.className = 'entry';

  wrap.innerHTML = `
    <div class="entry-head">
      <div class="entry-title" role="button" tabindex="0"></div>
      <div class="entry-time">${fmt(p.published)}</div>
    </div>
    <div class="entry-body">
      <div class="content"></div>
    </div>
  `;

  const titleEl = wrap.querySelector('.entry-title');
  const bodyEl  = wrap.querySelector('.entry-body');
  const contentEl = wrap.querySelector('.content');

  // gõ tiêu đề chậm theo 90 cpm
  typewriterText(titleEl, p.title);

  // set nội dung sẵn (GIỮ HTML blogger), nhưng ẩn cho tới khi mở
  contentEl.innerHTML = p.html;

  const open = ()=>{
    if(openedEntry && openedEntry!==wrap){
      openedEntry.classList.remove('open');
    }
    wrap.classList.toggle('open');
    openedEntry = wrap.classList.contains('open') ? wrap : null;
  };

  titleEl.onclick = open;
  titleEl.addEventListener('keydown', e=>{ if(e.key==='Enter' || e.key===' ') { e.preventDefault(); open(); } });

  return wrap;
}

async function renderListAccordion(items){
  const list = $('#list'); list.innerHTML='';
  if(!items.length){ list.innerHTML='<div class="center">Chưa có bài công khai.</div>'; return; }
  for(const p of items){
    const node = renderAccordionItem(p);
    list.appendChild(node);
  }
}

/* ==== Boot ==== */
(async ()=>{
  try{
    const raw = await fetchAllJSONP(BLOG_BASE, WANT_MAX);
    const posts = raw.map(normalize).sort((a,b)=>new Date(b.published)-new Date(a.published));
    document.getElementById('loading').remove();
    await renderListAccordion(posts);
  }catch(err){
    document.getElementById('loading').textContent = 'Lỗi tải (JSONP): ' + err.message;
  }
})();
</script>
</body>
</html>
