<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Nofi.vn</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;700;800&family=Merriweather:wght@900&display=swap" rel="stylesheet">

<style>
:root{ --footerH:52px; }

/* ===== BASE ===== */
html,body{
  margin:0;padding:0;width:100%;min-height:100%;
  background:radial-gradient(1200px 1200px at 10% -10%, var(--bg1) 0%, var(--bg2) 40%, var(--bg3) 100%);
  color:var(--fg);
  font:15.5px/1.65 "Inter",system-ui,sans-serif;
  -webkit-text-size-adjust:none; text-size-adjust:none;
}
body.modal-open{ overflow:hidden; } /* kho√° n·ªÅn khi m·ªü modal */

/* ===== THEMES ===== */
:root[data-theme="glass"]{
  --fg:#eae9e5; --muted:#a8b0ba;
  --panel:rgba(255,255,255,.06); --border:rgba(255,255,255,.14);
  --accent:#7dd3fc; --accent2:#a78bfa;
  --bg1:#1a2440; --bg2:#0b0f14; --bg3:#07090c;
  --link:#8ddcff; --placeholder:rgba(234,233,229,.55);
  --readerBg:rgba(18,22,27,.92);  /* üí° modal ƒë·∫≠m cho glass */
}
:root[data-theme="sepia"]{
  --fg:#2a2016; --muted:#6a5741;
  --panel:#fffdf7; --border:#e2d5bf;
  --accent:#d97706; --accent2:#a16207;
  --bg1:#f7efdf; --bg2:#f1e6d2; --bg3:#eadcc4;
  --link:#b45309; --placeholder:rgba(42,32,22,.45);
  --readerBg:#fffdf7;            /* gi·ªØ nh∆∞ gi·∫•y */
}
:root[data-theme="neon"]{
  --fg:#eceaff; --muted:#bfbaff;
  --panel:rgba(93,0,255,.22); --border:rgba(197,171,255,.35);
  --accent:#22d3ee; --accent2:#a855f7;
  --bg1:#12022b; --bg2:#0b0122; --bg3:#07001a;
  --link:#67e8f9; --placeholder:rgba(236,234,255,.55);
  --readerBg:rgba(18,22,27,.92);  /* üí° modal ƒë·∫≠m cho neon */
}

/* blobs */
.blob{position:fixed;inset:auto auto -22% -12%;width:60vmax;height:60vmax;
  background:radial-gradient(circle at 30% 30%,rgba(125,211,252,.25),transparent 60%);
  filter:blur(40px);pointer-events:none;animation:float 18s ease-in-out infinite alternate;z-index:0}
.blob.b2{inset:-18% -12% auto auto;width:55vmax;height:55vmax;
  background:radial-gradient(circle at 70% 40%,rgba(167,139,250,.22),transparent 60%);animation-duration:22s}
@keyframes float{to{transform:translate(2%,-3%) scale(1.05)}}

/* header */
.mast{max-width:1200px;margin:16px auto 8px;padding:10px 18px;display:flex;align-items:center;justify-content:space-between;position:relative;z-index:1}
.title{margin:0;font:900 24px "Merriweather",serif}
.now{font:700 12px/1 "Inter";color:var(--muted)}

/* toolbar */
.toolbar{max-width:1200px;margin:0 auto 10px;padding:0 18px;display:flex;gap:10px;align-items:center;flex-wrap:wrap;position:relative;z-index:1}
.input,.theme{display:flex;gap:8px;align-items:center;border:1px solid var(--border);background:var(--panel);padding:8px 10px;border-radius:12px}
.input{flex:1;min-width:260px}
.input input{width:100%;border:0;outline:0;background:transparent;color:var(--fg);font:600 14px "Inter"}
.input input::placeholder{color:var(--placeholder)}
.theme select{border:0;outline:0;background:transparent;color:var(--fg);font:700 13px "Inter"}

/* grid */
.gridWrap{max-width:1200px;margin:0 auto calc(60px + var(--footerH));padding:0 18px}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:14px}
.tile{padding:16px 14px;min-height:120px;display:flex;align-items:flex-start;gap:12px;background:var(--panel);border:1px solid var(--border);border-radius:16px;cursor:pointer;transition:all .25s}
.tile:hover{transform:translateY(-2px);background:rgba(255,255,255,.1)}
.dot{width:10px;height:10px;border-radius:50%;background:radial-gradient(circle at 30% 30%,var(--accent),var(--accent2));margin-top:4px}
.tTitle{font:800 16px/1.45 "Inter";color:var(--fg)}
.tMeta{font:700 11px/1 "Inter";color:var(--muted);margin-top:8px}

/* overlay */
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);opacity:0;visibility:hidden;z-index:3;transition:opacity .25s}
.overlay.open{opacity:1;visibility:visible}

/* reader modal (desktop/default) */
.reader{
  position:absolute;left:50%;top:140px;transform:translateX(-50%);
  width:min(1080px,94vw);max-height:75vh;
  background:var(--readerBg);color:var(--fg);
  border:1px solid var(--border);border-radius:18px;z-index:4;opacity:0;pointer-events:none;
  display:flex;flex-direction:column;box-shadow:0 40px 120px rgba(0,0,0,.6);
  transition:opacity .25s ease;
}
.reader.open{opacity:1;pointer-events:auto}
.reader h2{margin:0;font:800 20px "Inter";padding:14px 16px 4px}
.reader .meta{font:700 12px "Inter";color:var(--muted);padding:0 16px 10px}
.reader .body{
  padding:0 16px calc(16px + var(--footerH)); /* üí° ch·ª´a ch·ªó cho footer */
  font-size:16px;line-height:1.8;text-align:justify;
  overflow-y:auto;scrollbar-width:none;
}
.reader .body::-webkit-scrollbar{display:none}
.reader .signature{
  text-align:center;margin:20px 0 6px;color:var(--muted);
  font:700 13px "Inter";opacity:0;transition:opacity .2s ease;user-select:none;
}

/* Mobile: modal d√πng fixed ƒë·ªÉ lu√¥n treo theo viewport */
@media (max-width: 640px){
  .reader{
    position:fixed;left:50%;
    top:var(--topMob, 120px);transform:translateX(-50%);
    width:94vw;max-height:calc(100vh - var(--topMob) - 8px);
  }
}

/* footer (d∆∞·ªõi overlay, kh√¥ng nh·∫≠n click) */
.foot{
  position:fixed;left:0;right:0;bottom:0;
  display:flex;align-items:center;justify-content:center;
  height:var(--footerH); padding:10px 18px;
  font:700 12px "Inter";color:var(--muted);
  z-index:1; pointer-events:none;  /* üí° kh√¥ng che & kh√¥ng b·∫Øt c·ª≠ ch·ªâ */
}
</style>
</head>
<body>
<div class="blob"></div><div class="blob b2"></div>

<header class="mast">
  <h1 class="title">NOFI.VN</h1>
  <div id="now" class="now"></div>
</header>

<div class="toolbar">
  <div class="input">
    <input id="q" type="text" inputmode="search"
           autocomplete="off" autocorrect="off"
           autocapitalize="none" spellcheck="false"
           placeholder="T√¨m ti√™u ƒë·ªÅ‚Ä¶ (g√µ ƒë·ªÉ l·ªçc)">
  </div>
  <div class="theme">
    <label for="theme" style="font:700 12px 'Inter';opacity:.75;margin-right:4px">Giao di·ªán:</label>
    <select id="theme">
      <option value="glass">Glass Dark</option>
      <option value="sepia">Sepia Paper</option>
      <option value="neon">Neon Purple</option>
    </select>
  </div>
</div>

<main class="gridWrap">
  <div id="loading">ƒêang t·∫£i b√†i‚Ä¶</div>
  <section id="grid" class="grid" aria-live="polite"></section>
</main>

<div id="overlay" class="overlay"></div>

<aside id="reader" class="reader" aria-hidden="true">
  <h2 id="rTitle"></h2>
  <div id="rMeta" class="meta"></div>
  <div id="rBody" class="body"></div>
</aside>

<footer class="foot">T√¥i nh∆∞ tr·∫ª nh·ªè ng·ªìi b√™n hi√™n nh√† ch·ªù nghe th·∫ø k·ª∑ t√†n phai</footer>

<script>
const BLOG_BASE="https://blognofivn.blogspot.com";
const WANT_MAX=80;
document.getElementById('now').textContent=new Date().toLocaleString('vi-VN');

/* theme init */
const root=document.documentElement,themeSelect=document.getElementById('theme');
(function(){const stored=localStorage.getItem('nofi_theme')||'glass';
  root.setAttribute('data-theme',stored);themeSelect.value=stored;})();
themeSelect.addEventListener('change',()=>{
  root.setAttribute('data-theme',themeSelect.value);
  localStorage.setItem('nofi_theme',themeSelect.value);
});

/* utils */
const $=(s,el=document)=>el.querySelector(s);
const fmt=s=>s?new Date(s).toLocaleString('vi-VN'):'';
const norm=(s='')=>s.toLowerCase()
  .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
  .replace(/ƒë/g,'d').replace(/ƒê/g,'d');

/* JSONP fetch */
function jsonp(url){return new Promise((resolve,reject)=>{
  const cb="cb_"+Math.random().toString(36).slice(2);
  const sc=document.createElement('script');
  sc.src=url+(url.includes('?')?'&':'?')+'callback='+cb;
  let done=false;
  window[cb]=(data)=>{done=true;resolve(data);cleanup();};
  sc.onerror=()=>{if(!done){reject(new Error('JSONP load error'));cleanup();}};
  function cleanup(){delete window[cb];sc.remove();}
  document.body.appendChild(sc);
});}
async function fetchAllJSONP(base=BLOG_BASE,wanted=WANT_MAX){
  let url=base.replace(/\/?$/,'')+'/feeds/posts/default?alt=json-in-script&max-results=100';
  const out=[];
  for(let i=0;i<10&&out.length<wanted&&url;i++){
    const d=await jsonp(url);
    const entries=(d.feed&&d.feed.entry)||[];
    out.push(...entries);
    const next=(d.feed&&d.feed.link||[]).find(l=>l.rel==='next');
    if(next&&next.href){
      url=next.href.replace('alt=json','alt=json-in-script');
      if(!/alt=json-in-script/.test(url)) url+=(url.includes('?')?'&':'?')+'alt=json-in-script';
    }else url=null;
  }
  return out.slice(0,wanted);
}

/* sanitize + normalize */
const SCRIPT_RE=/<script[\s\S]*?<\/script>/gi;
const STYLE_RE =/<style[\s\S]*?<\/style>/gi;
function sanitizeHTML(html=''){return(html||'').replace(SCRIPT_RE,'').replace(STYLE_RE,'');}
function normalize(e){
  const title=(e.title&&e.title.$t)||'(Kh√¥ng ti√™u ƒë·ªÅ)';
  const html=(e.content&&e.content.$t)||(e.summary&&e.summary.$t)||'';
  return {title,published:e.published?e.published.$t:'',html:sanitizeHTML(html)};
}

/* render grid */
let POSTS=[];
function renderGrid(list){
  const grid=$('#grid');grid.innerHTML='';
  list.forEach(p=>{
    const tile=document.createElement('article');
    tile.className='tile';
    tile.innerHTML=`<div class="dot"></div>
      <div style="min-width:0"><div class="tTitle">${p.title}</div>
      <div class="tMeta">${fmt(p.published)}</div></div>`;
    tile.addEventListener('click',()=>openReaderFromTile(tile,p));
    grid.appendChild(tile);
  });
}

/* search filter (IME-friendly) */
const qEl=document.getElementById('q');let composing=false,rafId=0;
function runFilter(){
  cancelAnimationFrame(rafId);
  rafId=requestAnimationFrame(()=>{
    const kw=norm(qEl.value.trim());
    const filtered=kw?POSTS.filter(p=>norm(p.title).includes(kw)):POSTS;
    renderGrid(filtered);
  });
}
qEl.addEventListener('compositionstart',()=>{composing=true;});
qEl.addEventListener('compositionend',()=>{composing=false;runFilter();});
qEl.addEventListener('input',()=>{if(!composing)runFilter();},{passive:true});
qEl.addEventListener('keyup',()=>{if(!composing)runFilter();},{passive:true});
qEl.addEventListener('search',runFilter,{passive:true});

/* open reader */
function openReaderFromTile(tile,p){
  const reader=$('#reader'),overlay=$('#overlay'),body=$('#rBody');
  // set content
  $('#rTitle').textContent=p.title;
  $('#rMeta').textContent=fmt(p.published);
  body.innerHTML=p.html;
  // signature cu·ªëi b√†i
  const sig=document.createElement('div');
  sig.className='signature';
  sig.textContent='‚îÄ‚îÄ‚îÄ ‚ùñ ‚îÄ‚îÄ‚îÄ';
  body.appendChild(sig);

  // v·ªã tr√≠ d∆∞·ªõi toolbar (desktop) & top mobile
  const tb=document.querySelector('.toolbar').getBoundingClientRect();
  reader.style.top=Math.round(tb.bottom+45)+'px';
  // mobile top var
  const topMob=Math.max(96, Math.round(tb.bottom+24));
  reader.style.setProperty('--topMob', topMob+'px');

  // m·ªü layer + kho√° n·ªÅn
  overlay.classList.add('open');
  reader.classList.add('open');
  reader.setAttribute('aria-hidden','false');
  document.body.classList.add('modal-open');

  // show/hide signature theo scroll
  function onScroll(){
    const nearBottom=body.scrollTop+body.clientHeight>=body.scrollHeight-5;
    sig.style.opacity=nearBottom?1:0;
  }
  body.addEventListener('scroll',onScroll);
  onScroll();

  // ƒë√≥ng
  const close=()=>{
    overlay.classList.remove('open');
    reader.classList.remove('open');
    reader.setAttribute('aria-hidden','true');
    document.body.classList.remove('modal-open');
    overlay.removeEventListener('click',close);
    body.removeEventListener('scroll',onScroll);
  };
  overlay.addEventListener('click',close,{once:true});
}

/* boot */
(async()=>{
  try{
    const raw=await fetchAllJSONP(BLOG_BASE,WANT_MAX);
    POSTS=raw.map(normalize).sort((a,b)=>new Date(b.published)-new Date(a.published));
    document.getElementById('loading')?.remove();
    renderGrid(POSTS);
  }catch(err){
    document.getElementById('loading').textContent='L·ªói t·∫£i (JSONP): '+err.message;
  }
})();
</script>
</body>
</html>
